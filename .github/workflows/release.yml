name: Production Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0, v1.2.3

jobs:
  production-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci  # ä½¿ç”¨ ci ç¡®ä¿ä¾èµ–ç‰ˆæœ¬ç²¾ç¡®

    - name: Compile TypeScript
      run: npm run compile

    - name: Get package info
      id: pkg
      run: |
        echo "name=$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT
        echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
        echo "description=$(node -p "require('./package.json').description")" >> $GITHUB_OUTPUT
        echo "build_date=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT
        echo "changelog=$(git log --oneline -n 20 --format='- %s' $(git describe --tags --abbrev=0 2>/dev/null || echo 'HEAD')..HEAD || echo 'Initial release')" >> $GITHUB_OUTPUT

    - name: Validate version match
      run: |
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "âŒ é”™è¯¯: Git æ ‡ç­¾ç‰ˆæœ¬ ($TAG_VERSION) ä¸ package.json ç‰ˆæœ¬ ($PACKAGE_VERSION) ä¸åŒ¹é…"
          exit 1
        fi

    - name: Package extension
      run: |
        npm install -g @vscode/vsce
        vsce package --out ${{ steps.pkg.outputs.name }}-${{ steps.pkg.outputs.version }}.vsix

    - name: Create Production Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "v${{ steps.pkg.outputs.version }}"
        body: |
          # ğŸ‰ ${{ steps.pkg.outputs.name }} v${{ steps.pkg.outputs.version }}

          **${{ steps.pkg.outputs.description }}**

          ## ğŸ“¦ å‘å¸ƒä¿¡æ¯

          - **ç‰ˆæœ¬**: v${{ steps.pkg.outputs.version }}
          - **æ„å»ºæ—¶é—´**: ${{ steps.pkg.outputs.build_date }}
          - **Node.js**: 22.x
          - **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

          ## ğŸ“ æ›´æ–°å†…å®¹

          ${{ steps.pkg.outputs.changelog }}

          ## ğŸ”§ å®‰è£…è¯´æ˜

          1. ä¸‹è½½ä¸‹æ–¹çš„ `.vsix` æ–‡ä»¶
          2. åœ¨ VSCode ä¸­æŒ‰ `Ctrl+Shift+P` (Windows) æˆ– `Cmd+Shift+P` (Mac)
          3. è¾“å…¥ "Extensions: Install from VSIX"
          4. é€‰æ‹©ä¸‹è½½çš„ .vsix æ–‡ä»¶è¿›è¡Œå®‰è£…

          ## ğŸ“‹ æ ¡éªŒä¿¡æ¯

          ```bash
          # SHA256 æ ¡éªŒå’Œ
          sha256sum: ${{ hashFiles('*.vsix') }}
          ```

          ---
          *æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºçš„ç”Ÿäº§ç‰ˆæœ¬*
        draft: false
        prerelease: false
        files: |
          *.vsix
          LICENSE
          README.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}